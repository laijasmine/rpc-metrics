---
title: "Volunteer Hours"
format: html
knitr:
  opts_chunk: 
    collapse: true
    comment: "#" 
    echo: false
    message: false
---

```{r setup}
library(googlesheets4)
library(ggplot2)
library(dplyr)
library(lubridate)
library(DT)
library(glue)
library(tidyr)
library(plotly)
library(stringr)
```

```{r google_sheet}
membership_sheet <- "https://docs.google.com/spreadsheets/d/1Ldrcx_iVWi2Bv3GQoIHE2hOkf0Ah-nKVK3GFnXBXfts/edit?gid=1039957161#gid=1039957161"
membership <- read_sheet(membership_sheet, sheet = "2025-2026")

volunteer_sheet <- "https://docs.google.com/spreadsheets/d/1Tj7O8SzHRy_FgNHE84TD9od4CIbv_WVIpoqORUdNB8s/edit?gid=303571686#gid=303571686"
volunteer_sheet <- read_sheet(volunteer_sheet, sheet = "Total Raw Data")
```


```{r}
ordered_year_month <- purrr::map(
  2025:year(Sys.Date()),
  ~ paste(.x, month.abb)
) |>
  unlist()

volunteer_sheet_clean <- volunteer_sheet |>
  mutate(
    month = month(`Date of Volunteer Activity`, label = TRUE),
    year = year(`Date of Volunteer Activity`),
    year_month = glue("{year} {month}"),
    year_month_factor = factor(
      year_month,
      levels = ordered_year_month
    ),
    member = str_replace_all(`Column 2`, "\\b([A-Za-z])[A-Za-z]*\\b", "\\1")
  ) |>
  filter(`Column 2` != "Justin Ng") |>
  # add branches instead of relying on the sheet
  select(-Branch) |>
  left_join(membership, by = join_by("Column 2" == "Full Name"))

branch_members <- membership |>
  count(`Assigned Branch`)
```

Hours as of `r Sys.Date()`
  
# Total Volunteer Hours
```{r}
volunteer_sheet_clean |>
  pull(Hours) |>
  sum()
```

# Current Month Stats

```{r}
current_month <- month(Sys.Date(), label = TRUE)
current_year <- year(Sys.Date())
current_month_data <- volunteer_sheet_clean |>
  filter(year_month == glue("{current_year} {current_month}"))
current_volunteers <- length(unique(current_month_data$`Column 2`))
```

Stats for `r current_year` `r current_month`

  - Total hours `r sum(current_month_data$Hours)`
  - Number of unique volunteers `r current_volunteers`
        
```{r}
current_month_plot <- current_month_data |>
  ggplot(aes(
    x = `Assigned Branch`,
    y = Hours,
    fill = `Assigned Branch`
  )) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplotly(current_month_plot)

current_month_data |>
  select("Assigned Branch", "Description of volunteer activity", "Hours") |>
  arrange(Hours) |>
  datatable()
```

# Hours By Branch
```{r}
programming_plot <- volunteer_sheet_clean |>
  group_by(year_month_factor, `Assigned Branch`) |>
  summarise(total_hours = sum(Hours)) |>
  ggplot(aes(
    x = year_month_factor,
    y = total_hours,
    fill = `Assigned Branch`
  )) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplotly(programming_plot)

programming_plot_branch <- programming_plot +
  facet_wrap(~`Assigned Branch`) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)
  )

ggplotly(programming_plot_branch)
```

```{r}
volunteer_sheet_clean |>
  group_by(`Assigned Branch`) |>
  summarise("Total Branch Hours" = round(sum(Hours))) |>
  left_join(
    branch_members,
    by = join_by("Assigned Branch" == "Assigned Branch")
  ) |>
  mutate("Approximate Hours Per Person" = round(`Total Branch Hours` / n, 2)) |>
  rename("Number of members" = n) |>
  datatable()
```

```{r}
# volunteer_sheet_clean |>
#   group_by(year, month, `Assigned Branch`) |>
#   summarise("branch hours" = sum(Hours)) |>
#   datatable()

# plot_hours <- volunteer_sheet_clean |>
# ggplot(aes(
#     x = month,
#     y = Hours,
#     fill = `Programming Event you volunteered for (if any)`
#   )) +
#     geom_col() +
#     facet_grid(~`Assigned Branch`)

# ggplotly(plot_hours)
```


## Volunteer Hour Description
Extracted the first word from the description (usually the most important word. Plot shows the top 10 items.
```{r}
volunteer_sheet_activity <- volunteer_sheet_clean |>
  mutate(
    activity = tolower(`Description of volunteer activity`),
    activity = str_extract(activity, "^[^\\s]+")
  )

top_activity <- volunteer_sheet_activity |>
  filter(!is.na(activity)) |>
  count(activity) |>
  arrange(desc(n))

plot_description <- volunteer_sheet_activity |>
  filter(activity %in% top_activity$activity[1:10]) |>
  group_by(month, activity) |>
  summarise(total_hours = sum(Hours)) |>
  ggplot(aes(x = month, y = total_hours, fill = activity)) +
  geom_col()

ggplotly(plot_description)
```

# Event Hours
```{r}
volunteer_sheet_clean |>
  group_by(`Programming Event you volunteered for (if any)`) |>
  summarise("Program Hours" = round(sum(Hours), 2)) |>
  datatable()
```

# Quality control

## Check for outlier points
```{r}
hours_plot <- volunteer_sheet_clean |>
  ggplot(aes(
    x = `Date of Volunteer Activity`,
    y = Hours,
    color = `Assigned Branch`
  )) +
  geom_point()

ggplotly(hours_plot)
```

Check for invalid hours
```{r}
# volunteer_sheet_clean |>
#   filter(Hours < 0)
```

```{r}
volunteer_sheet_branches <- volunteer_sheet_clean |>
  filter(!is.na(`Assigned Branch`) | `Assigned Branch` != "#N/A")

available_branches <- unique(volunteer_sheet_branches$`Assigned Branch`)

plot_list <- htmltools::tagList()
for (branch in available_branches) {
  volunteer_branch <- volunteer_sheet_branches |>
    filter(branch == `Assigned Branch`) |>
    ggplot(aes(
      x = `Date of Volunteer Activity`,
      y = Hours,
      color = member,
      group = member
    )) +
    geom_point() +
    geom_line() +
    ggtitle(branch)
  # Append a header and the plot to the list
  plot_list <- htmltools::tagList(
    plot_list,
    ggplotly(volunteer_branch)
  )
}

plot_list
```

